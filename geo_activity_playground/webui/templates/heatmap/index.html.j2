{% extends "page.html.j2" %}

{% block container %}
<h1 class="mb-3">{{ _('Heatmap') }}</h1>

<div class="mb-3">
    {% include "search_form.html.j2" %}
</div>

<div class="row mb-3">
    <div class="col">
        <div id="heatmap-map" style="height: 800px;"></div>
        <p><a href="#" id="heatmap-download">{{ _('Download heatmap in visible area') }}</a></p>

        <script type="module">
            import { add_layers_to_map } from '/static/map-layers.js';

            const map = L.map('heatmap-map', {
                fullscreenControl: true,
                center: [{{ center.latitude }}, {{ center.longitude }}],
                zoom: 12
            });

            add_layers_to_map(map, {
                zoom: 14,
                attribution: '{{ map_tile_attribution|safe }}',
                baseLayer: 'Inverse Grayscale',
                overlay: 'Heatmap',
                heatmapExtraArgs: '{{ extra_args|safe }}' || null
            });

            const bbox = {{ center.bbox | safe }};
            if (bbox) {
                map.fitBounds(L.geoJSON(bbox).getBounds());
            }

            document.getElementById('heatmap-download').addEventListener('click', (e) => {
                e.preventDefault();
                const bounds = map.getBounds();
                window.location.href =
                    `/heatmap/download/${bounds.getNorth()}/${bounds.getEast()}/${bounds.getSouth()}/${bounds.getWest()}/heatmap.png?{{ extra_args|safe }}`;
            });
        </script>
    </div>
</div>

{% endblock %}