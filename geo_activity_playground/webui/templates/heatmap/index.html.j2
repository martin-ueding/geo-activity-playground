{% extends "page.html.j2" %}

{% block container %}
<h1 class="mb-3">Heatmap</h1>

<div class="mb-3">
    {% include "search_form.html.j2" %}
</div>

<div class="row mb-3">
    <div class="col">
        <div id="heatmap-map" style="height: 800px;"></div>
        <p><a href="#" onclick="downloadAs()">Download heatmap in visible area</a></p>

        <script type="module">
            import { add_layers_to_map } from '/static/map-layers.js';

            const zoom = 14;
            const map_tile_attribution = '{{ map_tile_attribution|safe }}';
            const heatmap_extra_args = '{{ extra_args|safe }}';

            const map = L.map('heatmap-map', {
                fullscreenControl: true,
                center: [{{ center.latitude }}, {{ center.longitude }}],
                zoom: 12
            });

            add_layers_to_map(map, zoom, map_tile_attribution, "Inverse Grayscale", "Heatmap");

            const bbox = {{ center.bbox| safe }}
            if (bbox) {
                map.fitBounds(L.geoJSON(bbox).getBounds())
            }

            function downloadAs() {
                const bounds = map.getBounds()
                window.location.href =
                    `/heatmap/download/${bounds.getNorth()}/${bounds.getEast()}/${bounds.getSouth()}/${bounds.getWest()}/heatmap.png?{{ extra_args|safe }}`
            }

            // Expose for onclick handler
            window.downloadAs = downloadAs;
        </script>
    </div>
</div>

{% endblock %}