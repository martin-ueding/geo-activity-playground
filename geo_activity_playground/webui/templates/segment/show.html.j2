{% extends "page.html.j2" %}

{% block container %}
<div class="row mb-3">
    <div class="col">
        <h1>{{ segment.name }}</h1>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4">
        <dl>
            <dt>Length</dt>
            <dd>{{ segment.length_km | round(2) }} km</dd>

            <dt>Total Efforts</dt>
            <dd>{{ matches | length }}</dd>

            <dt>Created</dt>
            <dd>{{ segment.created_at | dt }}</dd>
        </dl>

        <a href="{{ url_for('segment.index') }}" class="btn btn-secondary">Back to Segments</a>
        <form method="POST" action="{{ url_for('segment.delete', id=segment.id) }}" 
              style="display: inline;"
              onsubmit="return confirm('Are you sure you want to delete this segment?');">
            <button type="submit" class="btn btn-danger">Delete Segment</button>
        </form>
    </div>
    <div class="col-md-8">
        <div id="segment-map" style="height: 400px;"></div>
        <script>
            var map = L.map('segment-map', {
                fullscreenControl: true
            });
            L.tileLayer('/tile/pastel/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '{{ map_tile_attribution|safe }}'
            }).addTo(map);

            let geojson = L.geoJSON({{ segment_geojson | safe }}, {
                style: { 
                    color: "#e41a1c",
                    weight: 5,
                    opacity: 0.9
                }
            }).addTo(map);
            map.fitBounds(geojson.getBounds());
        </script>
    </div>
</div>

{% if matches %}
<div class="row mb-3">
    <div class="col">
        <h2>Efforts ({{ matches | length }})</h2>
        <p class="text-muted">Sorted by duration (fastest first)</p>
        
        <div class="table-responsive">
            <table class="table table-striped table-sort table-arrows">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Activity</th>
                        <th>Date</th>
                        <th class="numeric-sort">Duration</th>
                        <th class="numeric-sort">Distance</th>
                        <th>Entry</th>
                        <th>Exit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for match in matches %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td><a href="{{ url_for('activity.show', id=match.activity_id) }}">{{ match.activity.name }}</a></td>
                        <td>{{ match.activity.start | dt if match.activity.start else "—" }}</td>
                        <td>{{ match.duration | td if match.duration else "—" }}</td>
                        <td>{% if match.distance_km %}{{ match.distance_km | round(2) }} km{% else %}—{% endif %}</td>
                        <td>{{ match.entry_time.strftime("%H:%M:%S") if match.entry_time else "—" }}</td>
                        <td>{{ match.exit_time.strftime("%H:%M:%S") if match.exit_time else "—" }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if matches | length > 1 %}
<div class="row mb-3">
    <div class="col-md-6">
        <h3>Statistics</h3>
        <dl>
            {% set durations = matches | selectattr('duration') | map(attribute='duration') | list %}
            {% if durations %}
            <dt>Fastest Time</dt>
            <dd>{{ durations | first | td }}</dd>
            
            <dt>Slowest Time</dt>
            <dd>{{ durations | last | td }}</dd>
            {% endif %}
        </dl>
    </div>
</div>
{% endif %}

{% else %}
<div class="row mb-3">
    <div class="col">
        <p>No activities have matched this segment yet.</p>
    </div>
</div>
{% endif %}

{% endblock %}

